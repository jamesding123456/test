{"curuser":"Marilyn Zhang\/CHINA\/MXIC","op_user":"Alvin Lin\/TAIWAN\/MXIC","ftp_account":"alvinlin"}



<?php

/***************************************************

 * FTP 账号变更 API

 * 接收 JSON 请求，生成随机密码

 * 返回 JSON 格式 {"account":"xxx","password":"xxx"}

 * 请求数据记录日志

 ***************************************************/




// 设置返回 JSON

header('Content-Type: application/json; charset=utf-8');




// ---------- 日志函数 ----------

function log_request($user, $password, $status, $msg = '') {

    $log_file = __DIR__ . '/ftp_change_account.log';

    $time = date('Y-m-d H:i:s');

    $entry = "[$time] user: $user | password: $password | status: $status | message: $msg\n";

    file_put_contents($log_file, $entry, FILE_APPEND);

}




// ---------- 接收 JSON 请求 ----------

$input = file_get_contents('php://input');

$data = json_decode($input, true);




$user = trim($data['user'] ?? '');

if ($user === '') {

    http_response_code(400);

    log_request($user, '', 'error', 'Missing required field: user');

    echo json_encode(["error" => "Missing required field: user"]);

    exit;

}




// ---------- 用户名格式校验 ----------

if (!preg_match('/^[a-z0-9]+$/i', $user)) {

    http_response_code(400);

    log_request($user, '', 'error', 'Invalid username format');

    echo json_encode(["error" => "Invalid username format"]);

    exit;

}




// ---------- 生成随机密码 ----------

function random_password($length = 12) {

    $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=';

    $pass = '';

    $max = strlen($chars) - 1;

    for ($i=0; $i<$length; $i++) {

        $pass .= $chars[random_int(0, $max)];

    }

    return $pass;

}




$new_pass = random_password(12);




// ---------- 系统命令执行 ----------

$user_escaped = escapeshellarg($user);




// 检查用户是否存在

$check_cmd = "id -u $user_escaped >/dev/null 2>&1";

system($check_cmd, $retval);

if ($retval !== 0) {

    http_response_code(404);

    log_request($user, $new_pass, 'error', 'User not found');

    echo json_encode(["error" => "User not found"]);

    exit;

}




// 修改密码

$cmd = "echo \"$user:$new_pass\" | sudo chpasswd";

exec($cmd, $output, $ret);




if ($ret !== 0) {

    http_response_code(500);

    log_request($user, $new_pass, 'error', 'Failed to update password');

    echo json_encode(["error" => "Failed to update password"]);

    exit;

}




// ---------- 返回结果 ----------

log_request($user, $new_pass, 'success', 'Password updated successfully');

echo json_encode([

    "account" => $user,

    "password" => $new_pass

]);
